<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI × p5play</title>
    <style>
      body {
        margin: 0;
        background-color: #999;
        overflow: hidden;
      }

      canvas {
        display: block;
        margin: 20px auto;
        border: 4px solid #000;
      }
    </style>
  </head>
  <body>
    <h1>AI Shooting Game</h1>
    <div id="ui" style="margin-bottom: 10px">
      <input
        type="text"
        id="promptInput"
        placeholder="例: 伝説の勇者、スライム"
        size="30"
      />
      <button id="sendButton">召喚してスタート</button>
      <div
        id="aiMessage"
        style="margin-top: 5px; font-weight: bold; color: blue"
      >
        AI:
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.11.4/lib/p5.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.11.4/lib/addons/p5.sound.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/planck@latest/dist/planck.min.js"></script>
    <script src="https://p5play.org/v3/p5play.js"></script>
    <script>
      let player, floor, enemy;
      let enemies;
      let gameParams = {
        speed: 5,
        jump: 5,
        bounce: 0.2,
        scale: 6,
        art: [
          '..bbbb..',
          '.b....b.',
          'b.b..b.b',
          'b......b',
          'b.bbbb.b',
          'b.b..b.b',
          '.b....b.',
          '..bbbb..',
        ],
        palette: { b: 'blue' },
      };

      // ゲームの状態管理用フラグ
      let isGameStarted = false; // スタートしたか？
      let isGameOver = false; // 負けたか？

      // AIサーバーのURL（自分の環境に合わせて書き換える）
      const serverUrl = 'https://gemini.takagino.workers.dev/api/gemini';

      const instruction = `
  あなたはゲームのデザイナーです。
  ユーザーの入力から連想される「キャラクター（10マスx10マスのドット絵）」と「ステータス」を決定してください。

  必ず以下のJSON形式で出力してください。
  {
    "speed": 数値 (3〜10, プレイヤーの速さ),
    "jump": 数値 (3〜10, ジャンプ力),
    "bounce": 数値 (0〜1, 反発力),
    "scale": 数値 (3〜10, ドット絵の拡大率)
    "art": [
      '...bbbb...',
      '..b....b..',
      '.b.b..b.b.',
      '.b......b.',
      '.b.bbbb.b.',
      '.b.b..b.b.',
      '..b....b..',
      '...bbbb...'
    ],
    "palette": {
      "a": "16進数コード (#RRGGBB)",
      "b": "16進数コード (#RRGGBB)",
      "c": "16進数コード (#RRGGBB)",
      "d": "16進数コード (#RRGGBB)",
      "e": "16進数コード (#RRGGBB)",
    },
    "message": "キャラ設定の一言解説"
  }

  ※artの値は、10マスx10マスのドット絵データ。「a,b,c,d,e」5つのアルファベットで形を構成し、空白は "." (ドット) で表現してください。
  ※paletteには、「a,b,c,d,e」5つのアルファベットに対応した色をすべて定義してください。背景色である白以外でお願いします。
`;

      function setupAI() {
        const btn = document.getElementById('sendButton');
        const input = document.getElementById('promptInput');
        const msgDisplay = document.getElementById('aiMessage');

        btn.addEventListener('click', async () => {
          const text = input.value;
          if (!text) return;

          // ボタン連打防止 & 入力欄からフォーカスを外す（重要）
          btn.disabled = true;
          btn.textContent = 'AI思考中...';
          input.blur();

          try {
            // 1. サーバーに送信 (POST)
            const response = await fetch(serverUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ prompt: text, instruction: instruction }),
            });

            // 2. 結果を受け取る
            const data = await response.json();
            const result = data.result;

            // ★まずはコンソールで中身を確認！
            console.log('AIからのデータ:', result);

            isGameStarted = true;
            isGameOver = false;

            gameParams = result;

            if (player) player.remove();

            enemies.removeAll();

            // 生成
            player = new Sprite(320, 100);
            player.image = spriteArt(
              gameParams.art,
              gameParams.scale,
              gameParams.palette
            );
            player.bounciness = gameParams.bounce;

            msgDisplay.textContent = `AI: 「${result.message}」`;
          } catch (e) {
            console.error(e);
            msgDisplay.textContent = 'エラーが発生しました';
          } finally {
            btn.disabled = false;
            btn.textContent = '召喚してリスタート';
          }
        });
      }

      function setup() {
        // 画面を作る (幅640px, 高さ480px)
        createCanvas(640, 480);

        // テキストの設定
        textSize(20); // 文字サイズ
        textAlign(CENTER); // 文字の行揃え

        world.gravity.y = 10;

        floor = new Sprite(320, 400, 500, 30);
        floor.color = 'gray';
        floor.collider = 'static';
        floor.friction = 0;

        enemies = new Group();
        enemies.r = 20;
        enemies.color = 'red';
        enemies.collider = 'kinematic';

        setupAI();
      }

      function draw() {
        // 背景を塗りつぶす (白)
        background('white');

        // 1. スタート前ならタイトルを表示して止める
        if (isGameStarted === false) {
          text('キャラクターの召喚してスタート', width / 2, height / 2);
          return; // ここで中断
        }

        // 2. ゲームオーバーなら表示して止める
        if (isGameOver === true) {
          text('GAME OVER', width / 2, height / 2);
          text('「s」キーでリトライ', width / 2, height / 2 + 40);
          return; // ここで中断
        }

        // --- 左右移動 ---
        if (kb.pressing('right')) {
          player.vel.x = gameParams.speed; // 右へ進む速度
        } else if (kb.pressing('left')) {
          player.vel.x = -gameParams.speed; // 左へ進む速度
        } else {
          player.vel.x = 0; // 止まる
        }

        // --- ジャンプ ---
        if (kb.presses('up') && player.colliding(floor)) {
          player.vel.y = -gameParams.jump; // 上方向への速度
        }

        if (frameCount % 90 === 0) {
          // 画面右端(width)の少し外、高さ360の位置に生成
          let enemy = new enemies.Sprite(width + 40, 360);
          enemy.vel.x = -5; // 左へ進む
        }

        // --- 後始末 ---
        // 画面左端から100px以上はみ出たら消す（メモリ節約）
        for (let enemy of enemies) {
          if (enemy.x < -100) enemy.remove();
        }

        if (player.collides(enemies)) {
          player.remove();
          isGameOver = true;
        }
      }

      function keyPressed() {
        // 「s」キーが押された時だけ実行する
        if (key === 's') {
          // ゲームオーバーならリセットする
          if (isGameOver === true) {
            isGameOver = false;
            isGameStarted = true;

            // ドット絵が適応された状態で復活させる
            player = new Sprite(320, 100);
            player.image = spriteArt(
              gameParams.art,
              gameParams.scale,
              gameParams.palette
            );
            player.bounciness = gameParams.bounce;

            // 敵を全消去
            enemies.removeAll();
          }
        }
      }
    </script>
  </body>
</html>
